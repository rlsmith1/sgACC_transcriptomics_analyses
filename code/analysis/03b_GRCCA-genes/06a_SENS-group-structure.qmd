---
title: "06a_SENS-group-structure"
author: "Rachel Smith"
format: html
editor: visual
---

# Sensitivity analyses of robustness of GRCCA results to grouping structure

Compare GRCCA results across distinct grouping structures:
(1) Plausible WGCNA solutions (biological groupings)
(2) Random groupings
(3) No grouping at all (RCCA; separate scripts)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
base_dir <- "~/Documents/PhD/projects/sgacc_wgcna_grcca/"
scripts_dir <- paste0(base_dir, "scripts/")
analysis_objects_dir <- paste0(base_dir, "outputs/objects/")
```

## Setup

```{r load_data}
source(paste0(scripts_dir, "load_WGCNA_res.R"))
library(tidyverse)
library(fgsea)
```

## Load sensitivity GRCCA data

```{r load_sensitivity}
sensitivity_dir <- paste0(base_dir, "objects/GRCCA_results_objects/")
sensitivity_objs <- list.files(paste0(base_dir, "objects/GRCCA_results_objects/"))


## Real WGCNA groupings
wgcna_groups <- sensitivity_objs[!str_detect(sensitivity_objs, "seed")]

l_wgcna_groups_res <- list()
for (obj in wgcna_groups){
    
    ## Identify WGCNA parameters used
    parameters <- str_extract(obj, "sft[^_]*_minSize[^_]*_cutHeight[^_]*")
    minimum_size <- str_extract(parameters, "(?<=minSize)\\d+") %>% as.numeric
    tree_cut_height <- str_extract(parameters, "(?<=cutHeight)\\d+\\.\\d+") %>% as.numeric
    
    ## Identify respective module assignments
    df_modules_filt_sens <- df_modules %>% 
        filter(min_size == minimum_size & cut_height == tree_cut_height) %>% 
        unite(mod_set, c(sft, min_size, cut_height), sep = "_") %>% 
        mutate(module = paste0("geneM", module) %>% factor(levels = paste0("geneM", module) %>% unique))
    
    ## Load GRCCA results
    load(paste0(sensitivity_dir, obj))
    
    ## Negate weights/structure correlations if SCZ is negative (want everything to be the same sign)
    SCZ_r <- df_y_res %>% filter(covariate == "SCZ") %>% pull(pearsons_r)
    
    if (SCZ_r < 0) {
        df_lvs <- df_lvs %>% mutate_at(vars(c(lvx, lvy)), ~ -.x)
        df_y_res <- df_y_res %>% mutate_at(vars(c(weight, z_score, pearsons_r)), ~ -.x)
        df_x_res <- df_x_res %>% mutate_at(vars(c(weight, z_score, pearsons_r)), ~ -.x)
    }
    
    ## Add gene symbols and module assignments to X res
    df_x_res <- df_x_res %>% 
        left_join(df_ensembl_to_symbol) %>% # add gene symbols
        left_join(df_modules_filt_sens) # add module assignment
    
    ## Save as list
    l_tmp <- list(
        "latent_variables" = df_lvs,
        "model_results" = df_results,
        "y_res" = df_y_res,
        "x_res" = df_x_res
    )
    
    ## Append to list
    l_wgcna_groups_res[[parameters]] <- l_tmp
    
}



## Random (permuted) WGCNA groupings
random_groups <- sensitivity_objs[str_detect(sensitivity_objs, "seed")]

l_random_groups_res <- list()
for (obj in random_groups){
    
    ## Identify seed used
    seed <- str_extract(obj, "(?<=seed)\\d+")

    ## Identify respective module assignments
    minimum_size <- 40
    tree_cut_height <- 0.98
    set.seed(seed)
    df_modules_filt_sens <- df_modules %>% 
        filter(min_size == minimum_size & cut_height == tree_cut_height) %>% 
        unite(mod_set, c(sft, min_size, cut_height), sep = "_") %>% 
        mutate(module = paste0("geneM", module) %>% factor(levels = paste0("geneM", module) %>% unique)) %>% 
        
        ## For *random* gene assignment within modules
        mutate(module = sample(module)) # turn off if not doing random assignment
        
    ## Load GRCCA results
    load(paste0(sensitivity_dir, obj))
    
    ## Negate weights/structure correlations if SCZ is negative (want everything to be the same sign)
    SCZ_r <- df_y_res %>% filter(covariate == "SCZ") %>% pull(pearsons_r)
    
    if (SCZ_r < 0) {
        df_lvs <- df_lvs %>% mutate_at(vars(c(lvx, lvy)), ~ -.x)
        df_y_res <- df_y_res %>% mutate_at(vars(c(weight, z_score, pearsons_r)), ~ -.x)
        df_x_res <- df_x_res %>% mutate_at(vars(c(weight, z_score, pearsons_r)), ~ -.x)
    }
    
    ## Add gene symbols and module assignments to X res
    df_x_res <- df_x_res %>% 
        left_join(df_ensembl_to_symbol) %>% # add gene symbols
        left_join(df_modules_filt_sens) # add module assignment
    
    ## Save as list
    l_tmp <- list(
        "latent_variables" = df_lvs,
        "model_results" = df_results,
        "y_res" = df_y_res,
        "x_res" = df_x_res
    )
    
    ## Append to list
    seed_name <- paste0("seed", seed) 
    l_random_groups_res[[seed_name]] <- l_tmp
    
}
```

## Load actual GRCCA results

```{r load_actual}
load(paste0(analysis_objects_dir, "GRCCA_results.Rdata")) # load actual GRCCA results
# df_results, df_lvs, df_y_res, df_x_res
```

## Format WGCNA groups comparisons

```{r format_wgcna}
## Module sizes
map(l_wgcna_groups_res, ~ .x$y_res)

## Model results
df_model_res_wgcna_groups <- map_dfr(l_wgcna_groups_res, ~.x$model_results) %>% 
    filter(set %in% 1:10) %>% 
    mutate(mod_set = rep(names(l_wgcna_groups_res), each = 10) %>% str_remove("sft3_"), .before = 1) %>% 
    bind_rows(
        df_results %>% mutate(mod_set = "actual (minSize40_cutHeight0.98)")
    ) 



## X and Y results

# format Y
df_y_res_wgcna_groups <- map_dfr(l_wgcna_groups_res, ~.x$y_res) %>% 
    mutate(mod_set = rep(names(l_wgcna_groups_res), each = length(df_y_res$covariate)) %>% str_remove("sft3_"), .before = 1) %>% 
    bind_rows(
        df_y_res %>% mutate(mod_set = "actual (minSize40_cutHeight0.98)")
    ) %>% 
    
    select(mod_set, covariate, pearsons_r) %>% 
    pivot_wider(names_from = mod_set, values_from = pearsons_r) %>% 
    
    # make sure every column is numeric
    dplyr::select(-covariate)

# format X
df_x_res_wgcna_groups <- map_dfr(l_wgcna_groups_res, ~.x$x_res) %>% 
    mutate(mod_set = rep(names(l_wgcna_groups_res), each = length(df_x_res$ensembl_gene_id)) %>% str_remove("sft3_"), .before = 1) %>% 
    bind_rows(
        df_x_res %>% mutate(mod_set = "actual (minSize40_cutHeight0.98)")
    ) %>% 
    
    select(mod_set, ensembl_gene_id, pearsons_r) %>% 
    pivot_wider(names_from = mod_set, values_from = pearsons_r) %>% 
    
    # make sure every column is numeric
    dplyr::select(-ensembl_gene_id)



## Risk gene enrichment
l_benchmarking_res_wgcna_groups <- map( .x = l_wgcna_groups_res, 
     .f = ~ fgsea(pathways = benchmarking_lists, 
                  stats = .x$x_res %>% 
                      arrange(-pearsons_r) %>% 
                      dplyr::select(ensembl_gene_id, pearsons_r) %>% 
                      deframe, 
                  eps = 0
     ) %>% 
         as_tibble() %>% 
         dplyr::rename("benchmark_list" = "pathway") %>% 
         arrange(-abs(NES))
)
l_benchmarking_res_wgcna_groups[["actual (minSize40_cutHeight0.98)"]] <- fgsea(pathways = benchmarking_lists, 
                                                                               stats = df_x_res %>% 
                                                                                   arrange(-pearsons_r) %>% 
                                                                                   dplyr::select(ensembl_gene_id, pearsons_r) %>% 
                                                                                   deframe, 
                                                                               eps = 0 ) %>% 
    as_tibble() %>% 
    dplyr::rename("benchmark_list" = "pathway") %>% 
    arrange(-abs(NES))

df_benchmarking_res_wgcna_groups <- bind_rows(l_benchmarking_res_wgcna_groups) %>% 
    mutate(mod_set = rep(names(l_benchmarking_res_wgcna_groups), each = 6) %>% str_remove("sft3_"), .before = 1)
```

## Format random groups comparisons

```{r format_random}
## Model results
df_model_res_random_groups <- map_dfr(l_random_groups_res, ~.x$model_results) %>% 
    filter(set %in% 1:10) %>% 
    mutate(seed = rep(names(l_random_groups_res), each = 10), .before = 1) %>% 
    bind_rows(
        df_results %>% mutate(seed = "actual")
    )
 

## X and Y results

# format Y
df_y_res_random_groups <- map_dfr(l_random_groups_res, ~.x$y_res) %>% 
    mutate(seed = rep(names(l_random_groups_res), each = length(df_y_res$covariate)), .before = 1) %>% 
    bind_rows(
        df_y_res %>% mutate(seed = "actual")
    ) %>% 
    
    select(seed, covariate, pearsons_r) %>% 
    pivot_wider(names_from = seed, values_from = pearsons_r) %>% 
    
    # make sure every column is numeric
    dplyr::select(-covariate)

# format X
df_x_res_random_groups <- map_dfr(l_random_groups_res, ~.x$x_res) %>% 
    mutate(seed = rep(names(l_random_groups_res), each = length(df_x_res$ensembl_gene_id)), .before = 1) %>% 
    bind_rows(
        df_x_res %>% mutate(seed = "actual")
    ) %>% 
    
    select(seed, ensembl_gene_id, pearsons_r) %>% 
    pivot_wider(names_from = seed, values_from = pearsons_r) %>% 
    
    # make sure every column is numeric
    dplyr::select(-ensembl_gene_id)


## Risk gene enrichment
l_benchmarking_res_random_groups <- map( .x = l_random_groups_res, 
                                        .f = ~ fgsea(pathways = benchmarking_lists, 
                                                     stats = .x$x_res %>% 
                                                         arrange(-pearsons_r) %>% 
                                                         dplyr::select(ensembl_gene_id, pearsons_r) %>% 
                                                         deframe, 
                                                     eps = 0
                                        ) %>% 
                                            as_tibble() %>% 
                                            dplyr::rename("benchmark_list" = "pathway") %>% 
                                            arrange(-abs(NES))
)
l_benchmarking_res_random_groups[["actual"]] <- fgsea(pathways = benchmarking_lists, 
                                                      stats = df_x_res %>% 
                                                          arrange(-pearsons_r) %>% 
                                                          dplyr::select(ensembl_gene_id, pearsons_r) %>% 
                                                          deframe, 
                                                      eps = 0 ) %>% 
    as_tibble() %>% 
    dplyr::rename("benchmark_list" = "pathway") %>% 
    arrange(-abs(NES))

df_benchmarking_res_random_groups <- bind_rows(l_benchmarking_res_random_groups) %>% 
    mutate(seed = rep(names(l_benchmarking_res_random_groups), each = 6), .before = 1)
```

## Save results for supplemental figures

```{r save}
## Save GRCCA results with WGCNA module solutions
save(
    df_model_res_wgcna_groups, df_x_res_wgcna_groups, df_y_res_wgcna_groups, df_benchmarking_res_wgcna_groups,
    file = paste0(analysis_objects_dir, "GRCCA_sensitivity_wgcna.Rdata")
)


## Save GRCCA results with random groupings
save(
    df_model_res_random_groups, df_x_res_random_groups, df_y_res_random_groups, df_benchmarking_res_random_groups,
    file = paste0(analysis_objects_dir, "GRCCA_sensitivity_random.Rdata")
)
```
