---
title: "01-01. Characterize the biological enrichments of the assigned modules"
author: "Rachel Smith"
format: html
editor: visual
---

Run GO and cell-type enrichment on WGCNA modules (gene-level).

The goal is to understand what each module represents biologically. Includes GO (+ topic modeling), cell type, and developmental trajectory.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
base_dir <- "~/Documents/PhD/projects/sgacc_wgcna_grcca/"
```

## Setup

```{r load_data}
source(paste0(scripts_dir, "load_WGCNA_res.R")) ## selects final module set (df_modules_filt)
```

## Run GO on each WGCNA module

Run GO pathway overrepresentation analysis on each module using enrichGO

```{r run_go}
modules <- df_modules_filt %>%
    pull(module) %>%
    unique()

doParallel::registerDoParallel()

df_mods_go <- map_dfr(
    .x = modules,
    .f = ~ enrichGO(
        gene = df_modules_filt %>% dplyr::filter(module == .x) %>% pull(ensembl_gene_id),
        OrgDb = "org.Hs.eg.db",
        universe = ensembl_gene_ids,
        keyType = "ENSEMBL",
        ont = "ALL",
        pAdjustMethod = "BH",
        pvalueCutoff = 1,
        qvalueCutoff = 1,
        readable = TRUE
    ) %>%
        as_tibble() %>%
        mutate(module = .x, .before = 1)
)


## Save results
prefix <- "08Mar2024_GENES_qSVAgeSexRaceGC" # Assuming prefix
soft_power <- 3 # Assuming soft_power
save(df_mods_go,
    file = paste0(objects_dir, prefix, "_SIGNED_SFT", soft_power, "_GO_RES.RDS")
)
```

## Run topic modeling on GO results for each module

Goal: understand what biological processes each module represents using the semantic similarity across GO term descriptions

```{r topic_modeling}
## Unnest tokens to get GO terms within each module (group)
df_go_tokens <- df_mods_go %>%
    dplyr::filter(pvalue < 0.05) %>%
    dplyr::filter(!is.na(Description)) %>%
    group_by(module) %>%
    unnest_tokens(word, Description)

## Create a sparse matrix using only meaningful words that appear at least twice within module
vague_terms <- c(
    "positive", "negative", "regulation", "response", "protein", "activity",
    "pathway", "process", "involved", "signaling"
)
go_sparse <- df_go_tokens %>%
    dplyr::count(module, word) %>%
    mutate(module = as.numeric(as.character(module %>% str_remove("geneM")))) %>%
    anti_join(stop_words) %>%
    dplyr::filter(n > 2 & !(word %in% vague_terms)) %>%
    cast_sparse(module, word, n)

dim(go_sparse)

## Fit topic model
set.seed(456)
n_topics <- 5
topic_model <- stm(go_sparse, K = n_topics, verbose = FALSE)


## Save the topic model and sparse matrix for plotting
save(go_sparse, topic_model,
    file = paste0(objects_dir, "topic_modeling_res.Rdata")
)
```

## Cell-type enrichment

Run hypergeometric test of each module with each Lake cell type

```{r cell_type}
df_mods_cell_type_hypergeometric <- expand_grid(
    cell_type = names(cell_types),
    module = modules
) %>%
    mutate(
        hypergeometric_res = map2(
            .x = cell_type,
            .y = module,
            .f = ~ f_module_hypergeometric(
                gene_list = cell_types[[.x]],
                gene_list_name = .x,
                wgcna_module = .y,
                gene_universe = ensembl_gene_ids,
                module_data = df_modules_filt
            ) %>%
                dplyr::select(-module)
        )
    ) %>%
    unnest(cols = c(hypergeometric_res)) %>%
    mutate(p_adj = p.adjust(p_value, method = "fdr"))

## Save for plotting
save(df_mods_cell_type_hypergeometric,
    file = paste0(objects_dir, "cell_type_res.RDS")
)
```

## Approximate developmental trajectory of each module

The data used in this section were shared with me as .Rdata files, but can be found in [Li et al *Science* (2018)](https://www.science.org/doi/10.1126/science.aat7615)

```{r development}
load(paste0(objects_dir, "psychencode_development_expr_data.Rdata")) # df_psychencode_metadata, df_psychencode_expr

## Identify frontal cortex samples
df_sample_window <- df_psychencode_metadata %>%
    dplyr::filter(region_broad == "frontal_cortex")
frontal_cortex_samples <- df_sample_window %>%
    pull(id)

## Filter expression data for samples and genes of interest
df_psychencode_expr_filt <- df_psychencode_expr %>%
    dplyr::filter(GENE %in% ensembl_gene_ids) %>%
    dplyr::select(GENE, all_of(frontal_cortex_samples)) %>%
    dplyr::rename("ensembl_gene_id" = "GENE")

## Combine expresion data and module data
df_expr_mod <- df_psychencode_expr_filt %>%
    pivot_longer(starts_with("HS"), names_to = "id", values_to = "expression") %>%
    left_join(df_sample_window) %>%
    left_join(df_modules_filt) %>%
    dplyr::select(ensembl_gene_id, module, id, window, expression)

## Find median expression value of each sample for each module
df_expr_mod_median <- df_expr_mod %>%
    group_by(module, id, window) %>%
    summarise(median_expr = median(expression))

## Save for plotting
save(df_expr_mod_median,
    file = paste0(objects_dir, "developmental_trajectory.RDS")
)
```

## Export module assignments and GO results as supplemental table

```{r tableS7}
write_xlsx(list(
    "A. Module gene assignments" = df_modules_filt %>% 
        left_join(df_ensembl_to_symbol) %>% 
        dplyr::select(module, color, ensembl_gene_id, gene_symbol) %>% 
        as.data.frame,
    "B. Module GO results" = df_mods_go %>% 
        dplyr::filter(pvalue < 0.05 & module != 0) %>% 
        dplyr::select(-qvalue) %>% 
        as.data.frame
),
path = paste0(tables_dir, "TableS7.WGCNA_module_results.xlsx")
)
```

## Plots

### Figure S7A \| Module sizes

```{r FigS7a.plot, fig.width = 3.5, fig.height = 2.5}
df_modules_filt %>% 
    dplyr::count(module, color) %>% 
    ggplot(aes(x = module, y = n)) +
    geom_col(aes(fill = module), color = "black", linewidth = 0.25) +
    geom_text(aes(label = n), size = 3, angle = 45, hjust = 0, vjust = 0) +
    scale_fill_manual(values = module_colors) +
    coord_cartesian(clip = "off") +
    labs(title = "A | Module sizes",
         x = NULL, y = "Number of genes") +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 45, hjust = 0.9, size = 8)
    )

## Save
map(
  .x = c(".png", ".pdf"),
  .f = ~ ggsave(paste0(supplement_figures_dir, "S7A.Module_sizes", .x), 
                width = 3.5, height = 2.5)
)
```

### Figure S7B \| Semantic themes across module GO results

```{r FigS7b.prep}
n_topics <- topic_model$settings$dim$K
## Extract topic descriptions (frequent words)
# FREX weights words by frequency and exclusivity to the topic
df_word_beta <- tidy(topic_model, matrix = "beta") %>%
    group_by(topic) %>%
    arrange(topic, -beta) %>% 
    top_n(n = 10, wt = beta) %>%
    mutate(topic = paste0("topic ", topic)) %>% 
    dplyr::filter(!str_detect(term, "cell")) %>% 
    group_by(topic) %>% 
    mutate(top_word = ifelse(beta == max(beta), "yes", "no"))

## Extract topic probabilities for each module (document)
df_group_gamma <- tidy(
    topic_model, 
    matrix = "gamma",
    document_names = rownames(go_sparse)) %>% 
    mutate(module = factor(document)) %>% 
    dplyr::select(module, topic, gamma) %>% 
    mutate(topic = factor(topic, levels = seq(n_topics, 1, by = -1)),
           module = paste0("geneM", module) %>% 
               factor(levels = paste0("geneM", levels(module)))) %>% 
    dplyr::filter(gamma > 0.01)
```

```{r FigS7b.plot, fig.width = 3, fig.height = 6}
## Plot word strength of association with each topic
p_figS7b_beta <- df_word_beta %>% 
    ggplot(aes(x = reorder_within(term, beta, topic), y = beta, fill = beta)) +
    geom_col(color = "#222222") +
    geom_text(aes(label = term, y = 0.001, size = beta, color = top_word), angle = 90, hjust = 0) +
    facet_wrap(vars(topic), ncol = 1, scales = "free_x") +
    scale_x_reordered() +
    scale_y_continuous(limits = c(0, 0.06), breaks = c(0, 0.05)) +
    scale_size_continuous(range = c(2, 3), guide = "none") +
    scale_color_manual(values = c("yes" = "white", "no" = "black"), guide = "none") +
    scale_fill_gradient(low = "white", high = "blue", guide = "none", limits = c(0, 0.058)) +
    labs(x = NULL, y = "Word strength of association with each topic") +
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          strip.background = element_rect(fill = "white", color = "black"),
          strip.text = element_text(size = 9)
    )

## Plot module strength of association with each topic
p_figS7b_gamma <- df_group_gamma %>%
    ggplot(aes(x = gamma, y = topic, color = module)) +
    geom_jitter(aes(alpha = gamma), position = position_jitter(seed = 2, width = 0.15)) +
    geom_text_repel(aes(alpha = gamma, label = module), size = 2.75, box.padding = 0.2, min.segment.length = 0,
                    max.overlaps = 15, position = position_jitter(seed = 2, width = 0.15)) +
    geom_hline(yintercept = c(1.5, 2.5, 3.5, 4.5, 5.5), color = "black", linewidth = 0.25) +
    scale_color_manual(values = module_colors) +
    labs(x = "Module strength of association \nwith each topic", y = NULL) +
    theme(legend.position = "none",
          axis.text.y = element_blank()
    )

## Combine & save
p_figS7b_beta + p_figS7b_gamma + 
    plot_layout(widths = c(1, 2)) + 
    plot_annotation(title = "B | GO semantic themes")
map(
  .x = c(".png", ".pdf"),
  .f = ~ ggsave(paste0(supp_figures_dir, "S7B.topic_modeling", .x), 
                width = 3, height = 6)
)
```

### Figure S7C \| Cell-type enrichment of GO modules

```{r FigS7c.prep}
df_figS7c <- df_mods_cell_type_hypergeometric %>%
    mutate(
        p_adj = ifelse(p_adj == 0, 10^-15, p_adj),
        color = ifelse(p_value < 0.05, paste0(module), NA) %>% factor,
        label = case_when(
            p_adj < 0.05 & p_adj > 0.01 ~ "*",
            p_adj < 0.01 & p_adj > 0.001 ~ "**",
            p_adj < 0.001 ~ "***",
            TRUE ~ ""
        )
    )
```

```{r FigS7c.plot, fig.width = 3.35, fig.height = 3.4}
df_figS7c %>% 
    ggplot(aes(x = cell_type, y = module)) +
    geom_tile(aes(fill = color, alpha = -log10(p_adj), color = color), 
              width = 0.95, height = 0.95, linewidth = 0.5) +
    geom_text(aes(label = label), vjust = 0.75, size = 3.5) +
    #annotate(geom = "text", label = "* = FDR < 0.05", x = 6.5, y = 1, size = 3) +
    scale_alpha_continuous(range = c(0.1, 1), na.value = 1) +
    scale_fill_manual(values = module_colors, na.value = "transparent", guide = "none") +
    scale_color_manual(values = module_colors, na.value = "transparent", guide = "none") +
    guides(alpha = guide_legend(title = "-log10(FDR)", title.position = "top", title.hjust = 0.5)) +
    labs(title =  "C | Cell-type enrichment", 
         x = NULL, y = NULL
    ) +
    theme(legend.position = "bottom",
          legend.margin = margin(t = -12),
          legend.key.size = unit(0.3, "cm"),
          legend.justification = "center",
          axis.text.y = element_text(size = 8.5),
          axis.text.x = element_text(angle = 45, hjust = 0.9)
    )

# Save
map(
  .x = c(".png", ".pdf"),
  .f = ~ ggsave(paste0(supp_figures_dir, "S7C.cell_type_enrichment", .x), 
                width = 3.35, height = 3.4)
)
```

### FIgure S7D \| Developmental trajectory of each module per PsychENCODE data

```{r FigS5d.plot, fig.width = 6.5, fig.height = 3}
df_expr_mod_median %>% 
    ggplot(aes(x = window, y = median_expr, color = module, fill = module)) +
    geom_smooth(method = "loess") +
    geom_vline(xintercept = 5, linewidth = 0.2) +
    facet_wrap( ~ module, scales = "free_y", nrow = 3) +
    scale_fill_manual(values = module_colors) +
    scale_color_manual(values = module_colors) +
    labs(x = "Developmental window", y = "Median expression (PsychENCODE)", 
         title = "D | Developmental expression trajectory of each module") +
    theme(legend.position = "none",
          strip.text.x = element_text(size = 9),
          strip.background = element_rect(fill = "white"),
          axis.text.x = element_blank(),
          panel.spacing = unit(0.05, "cm"),
          strip.clip = "off"
    )

## Save
map(
  .x = c(".png", ".pdf"),
  .f = ~ ggsave(paste0(supp_figures_dir, "S7D.developmental_trajectories", .x), 
                width = 6.5, height = 3)
)
```
