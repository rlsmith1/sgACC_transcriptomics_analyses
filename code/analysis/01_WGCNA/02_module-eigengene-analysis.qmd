---
title: "01-02. Identify WGCNA modules that are associated with psychiatric diagnosis using the traditional module eigengene approach"
author: "Rachel Smith"
format: html
editor: visual
---

This script runs PCA on each module expression matrix and correlates all module PCs with all covariates (including MCA dimensions). Extract PC1 results for module eigengene results.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
base_dir <- "~/Documents/PhD/projects/sgacc_wgcna_grcca/"
```

## Setup

```{r load_data}
source(paste0(scripts_dir, "load_WGCNA_res.R"))
```

## Data format

```{r format_data}
## Link dx to group number (in the numeric covariates tibble)
dx_group <- c(
    "BD" = 0,
    "Control" = 1,
    "MDD" = 2,
    "SCZ" = 3
)

## Combine known covariates with toxicology MCA dimensions
df_covariates_mca <- df_covariates_numeric %>%
    left_join(
        df_ind_loadings %>%
            dplyr::rename_at(vars(contains("dim")), ~ str_replace(.x, "dim", "MC")),
        by = join_by(sample)
    ) %>%
    # remove drug covariates (since we have the MCs)
    dplyr::select(-any_of(drug_covariates)) %>%
    # bring sample to column 1
    dplyr::select(sample, everything())
```

## Run PCA on each module

Run PCA on samples x gene expression matrix for each module

```{r pca}
df_mods_pca <- df_modules_filt %>%
    dplyr::select(module, ensembl_gene_id) %>%
    # combine with sample expression information
    left_join(
        df_vsd_regress %>%
            pivot_longer(2:ncol(.), names_to = "ensembl_gene_id", values_to = "resids"),
        by = join_by(ensembl_gene_id)
    ) %>%
    # create sample x gene expression matrix for each module
    group_by(module) %>%
    nest() %>%
    mutate(
        data = map(
            .x = data,
            .f = ~ .x %>%
                pivot_wider(
                    id_cols = sample,
                    names_from = ensembl_gene_id,
                    values_from = resids
                )
        )
    ) %>%
    # run PCA on gene x sample expression matrix
    mutate(pca = map(
        .x = data,
        .f = ~ .x %>%
            as.data.frame() %>%
            column_to_rownames("sample") %>%
            prcomp(center = TRUE, scale = TRUE)
    ))


## Extract sample scores in PC space
df_mods_pca_covariates <- df_mods_pca %>%
    # extract PC scores
    mutate(sample_pcs = map(
        .x = pca,
        .f = ~ .x$x %>%
            as.data.frame() %>%
            rownames_to_column("sample") %>%
            as_tibble() %>%
            pivot_longer(matches("PC"), names_to = "PC", values_to = "score") %>%
            # combine with PC variance explained
            left_join(
                summary(.x) %>%
                    .$importance %>%
                    t() %>% as.data.frame() %>%
                    rownames_to_column("PC") %>%
                    as_tibble() %>%
                    dplyr::rename("proportion_of_variance" = "Proportion of Variance") %>%
                    dplyr::select(PC, proportion_of_variance),
                by = join_by(PC)
            )
    )) %>%
    unnest(cols = c(sample_pcs)) %>%
    dplyr::select(module, sample, PC, proportion_of_variance, score) %>%
    # combine sample PC scores with sample covariate information
    left_join(
        df_covariates_mca %>%
            pivot_longer(2:ncol(.),
                names_to = "covariate",
                values_to = "covariate_val"
            ),
            by = join_by(sample)
    )
```

## Identify module-dx relationships across all module PCs

```{r identify_associations}
df_lm_dx_allPCs <- df_mods_pca_covariates %>%
    group_by(module, PC, proportion_of_variance) %>%
    filter(covariate %in% c("dx", paste0("MC", 1:8))) %>%
    pivot_wider(id_cols = c(module, PC, sample, proportion_of_variance, score), 
                names_from = covariate, 
                values_from = covariate_val) %>%
    # convert dx to factor variable for regression analyssi
    mutate(dx = case_when(
        dx == 0 ~ "BD",
        dx == 1 ~ "Control",
        dx == 2 ~ "MDD",
        dx == 3 ~ "SCZ"
    ) %>% factor(levels = names(dx_colors))) %>%
    nest() %>%
    # run linear models on each PC of each module to identify all dx associations
    mutate(
        # run linear models and extract results
        lm = map(
            .x = data,
            .f = ~ lm(score ~ dx + MC1 + MC2 + MC3 + MC4 + MC5 + MC6 + MC7 + MC8, data = .x)
        ),
        lm_sum = map(
            .x = lm,
            .f = ~ summary(.x)
        ),
        lm_res = map(
            .x = lm,
            .f = ~ tidy(.x)
        ),

        # take residuals without diagnosis for plotting
        data = map(
            .x = data,
            .f = ~ .x %>%
                mutate(pc_resids = lm(score ~ MC1 + MC2 + MC3 + MC4 + MC5 + MC6 + MC7 + MC8)
                       %>% residuals() + median(score)
                       )
        )
    ) %>%
    unnest(cols = c(lm_res)) %>%
    clean_names() %>%
    dplyr::filter(term != "(Intercept)") %>%
    group_by(module, term) %>%
    mutate(
        p_adj = p.adjust(p_value, method = "fdr"),
        term = str_remove(term, "dx")
    ) %>%
    # group_by(term) %>%
    # mutate(p_adj2 = p.adjust(p_value, method = "fdr")) %>%
    dplyr::select(-c(lm, lm_sum))


df_lm_dx_allPCs %>%
    filter(p_adj < 0.05 & proportion_of_variance >= 0.02 & module != "geneM0") %>%
    print(n = nrow(.))
```

## Extract module eigengene data only

```{r extract_eigengenes}
df_kme <- df_lm_dx_allPCs %>%
    filter(pc == "PC1")
```

## Save results

```{r save}
## Remove data to save
df_lm_dx_allPCs <- df_lm_dx_allPCs %>% dplyr::select(-data)

# Save
save(df_mods_pca_covariates, df_lm_dx_allPCs,
    file = paste0(objects_dir, "module_pca_res.RDS")
)
save(df_kme,
    file = paste0(objects_dir, "kME_analysis_res.RDS")
)
```

## Export module eigengene results as supplemental table

```{r tableS8}
write_xlsx(df_kme %>% 
               dplyr::filter(p_value < 0.05 & pc == "PC1") %>% 
               dplyr::select(-c(data, pc, proportion_of_variance, estimate, std_error)),
           path = paste0(tables_dir, "TableS8.kME_analysis_significant_results.xlsx")
)
```

## Plots

### Figure S20A \| Module eigengene-covariate associations

```{r FigS20a.prep}
df_figS20a <- df_lm_dx_allPCs %>% 
    filter(module != "geneM0" & pc == "PC1") %>% 
    mutate(term = str_replace(term, "MC", "Dim")) %>% 
    mutate(term = factor(term, levels = c(paste0("Dim", 8:1), names(dx_colors)))) %>%
    mutate(significant = ifelse(p_value < 0.05, "yes", "no")) %>% 
    arrange(abs(statistic))
```

```{r FigS20a.plot, fig.height = 3, fig.width = 6.5}
df_figS20a %>% 
    ggplot(aes(x = module, y = term)) +
    geom_hline(yintercept = 8.5, color = "gray") +
    geom_point(aes(fill = statistic, size = abs(statistic), color = significant), shape = 21) +
    scale_fill_gradientn(colors = gene_weight_color_scale, limits = c(-3.3, 3.3)) +
    scale_color_manual(values = c("yes" = "black", "no" = "grey")) +
    scale_size_continuous(limits = c(0, 3.3), range = c(0.5, 5), guide = "none") +
    guides(fill = guide_colorbar(title = "t-statistic", 
                                 title.position = "top", 
                                 title.hjust = 0.5),
           color = guide_legend(title = "P < 0.05", 
                                title.position = "top", 
                                title.hjust = 0.5)
    ) +
    coord_cartesian(clip = "off") +
    labs(x = NULL, y = NULL,
         title = "A | Module eigengene - covariate associations"
    ) +
    theme(
        legend.position = "bottom",
        legend.justification = "center",
        legend.margin = margin(t = -10),
        legend.key.height = unit(0.15, "cm"),
        legend.key.width = unit(0.75, "cm"),
        axis.text.x = element_text(size = 8.5, angle = 45, hjust = 0.9)
    )
map(
  .x = c(".png", ".pdf"),
  .f = ~ ggsave(paste0(supp_figures_dir, "S20a.module_kme_covar_matrix", .x), 
                width = 6.5, height = 3)
)
```

### Figure S20B \| Modules significantly associated with SCZ per module eigengene analysis

```{r FigS20b.prep}
df_figS20b <- df_lm_dx_allPCs %>% 
    dplyr::filter(p_value < 0.05 & term == "SCZ" & pc == "PC1") %>% 
    unnest(cols = c(data)) %>% 
    mutate(label = case_when(
        dx == "SCZ" & p_value < 0.05 & p_adj > 0.05 ~ "*",
        dx == "SCZ" & p_value < 0.05 & p_adj < 0.05 ~ "**",
        TRUE ~ ""
    )
    )
```

```{r FigS20b.plot, fig.height = 3, fig.width = 6.5}
df_figS20b %>% 
    ggplot(aes(x = pc_resids, y = dx, color = dx, fill = dx)) +
    geom_point(position = position_jitter(width = 0.1), size = 0.5, alpha = 0.75) +
    geom_boxplot(alpha = 0.1, outlier.shape = NA) +
    # geom_text(aes(label = label, x = -Inf), color = "black", size = 6,
    #           vjust = 0.75, hjust = -0.1, check_overlap = TRUE) +
    facet_wrap(vars(module), ncol = 3, scales = "free_x") +
    scale_fill_manual(values = dx_colors) +
    scale_color_manual(values = dx_colors) +
    labs(x = "kME (corrected for covariates)", y = NULL,
         #caption = "* = p < 0.05; ** = FDR < 0.05",
         title = "B | Module - SCZ associations"
    ) +
    theme(legend.position = "none",
          axis.text.y = element_text(size = 10)
    )

map(
  .x = c(".png", ".pdf"),
  .f = ~ ggsave(paste0(supp_figures_dir, "S20B.sig_SCZ_kME_modules", .x), 
                width = 6.5, height = 3)
)
```
