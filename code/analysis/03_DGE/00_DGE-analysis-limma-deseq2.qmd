---
title: "03-00. Run differential expression analysis using Limma-voom"
author: "Rachel Smith"
format: html
editor: visual
---

This script uses limma-voom to run DGE.

The model matrix includes the covariates that were selected as part of gene raw count preprocessing.

Limma-voom uses a linear model so it is most comparable to GRCCA.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
base_dir <- "~/Documents/PhD/projects/sgacc_wgcna_grcca/"
```

## Setup and Load Data

```{r load_data, message=FALSE, warning=FALSE}
## Run setup script
source(file.path(base_dir, "code/analysis/setup.R"))

## Gene raw counts
df_raw_counts <- read.table(paste0(base_dir, 
                                   "data/185samples_allGenes_auto-PARs_noSexChrs_noFilters_KoryAnalysis_21Kgenes.txt")
                            ) %>% 
    as_tibble(rownames = "ensembl_gene_id") %>% 
    rename_at(2:ncol(.), ~substr(.x, start = 2, stop = nchar(.x))) %>% 
    clean_names() %>% 
    dplyr::rename_at(2:ncol(.), ~str_remove(.x, "x"))

## Load QSVs (generated in 01_qSVA.R)
load(paste0(base_dir, "objects/06March2024_qSVs.Rdata"))

## Load MCA results
load(paste0(base_dir, "objects/drug_MCA_results.Rdata")) # df_ind_loadings, df_var_loadings
```

## Prepare covariate matrix

Combine qSVs and MCA with known data

```{r prep_covariates}
df_covariates_all <- df_covariates %>% 
    left_join(df_qsvs) %>% 
    left_join(
        df_ind_loadings %>%
            rename_with(~ str_replace(.x, "dim", "MC"), contains("dim")),
        by = join_by(sample)
    )


## Define covariates that we want to include in downstream models
n_mcs <- 8
keep_qsvs <- paste0("qSV", c(seq(1, 7), 9)) # correlate with known covariates or var explained > 2% (see 02.gene_raw_count_preprocessing.R)
technical_covariates <- c("sex_at_birth", "race", "age_death", "gc_percent")


## Convert to matrix, keeping only covariates to include in the models
m_covariates <- df_covariates_all %>%
    dplyr::filter(dx %in% c("SCZ", "Control")) %>%
    
    # convert character variables to factors (for DESeq2)
    mutate(
        dx = factor(dx, levels = c("Control", "SCZ")),
        sex_at_birth = factor(sex_at_birth, levels = c("Female", "Male")),
        race = factor(race, levels = c("Black or African-American", "White"))
    ) %>%
    
    # select covariates to include
    dplyr::select(sample, dx, 
                  all_of( c(
                      paste0("MC", 1:n_mcs),
                      keep_qsvs,
                      technical_covariates
                  )
                  )
    ) %>%
    column_to_rownames("sample")
```

## Raw count filtering

```{r filter_counts}
## Filter for samples that are in gene data
df_raw_counts <- df_raw_counts %>% 
    dplyr::select(ensembl_gene_id, contains(df_covariates$sample))


## Remove low count genes

# At least 10 raw counts in at least 80% of samples
keep <- df_raw_counts %>% 
    mutate_if(is.numeric, ~ifelse(.x >= 10, 1, 0)) %>% 
    mutate(thresh = rowSums(dplyr::select(., -ensembl_gene_id))/(ncol(.) - 1), 
           .before = 2) %>% 
    dplyr::filter(thresh >= 0.80) %>% 
    pull(ensembl_gene_id)
length(keep) # n = 18677

# filter df_raw_counts for genes that meet this threshold
df_raw_counts_filtered <- df_raw_counts %>% 
    dplyr::filter(ensembl_gene_id %in% keep)


## Match to samples of interest (SCZ and Control only)
df_raw_counts_filtered <- df_raw_counts_filtered %>% 
    dplyr::select(ensembl_gene_id, all_of(rownames(m_covariates)))


## Convert to matrix
m_counts <- df_raw_counts_filtered %>% 
    column_to_rownames("ensembl_gene_id")


## Check that sample ordering matches
all(colnames(m_counts) == rownames(m_covariates))


## Map ensembl IDs to gene symbols (save for later)
ensembl_gene_ids <- rownames(m_counts)
df_ensembl_to_symbol <- mapIds(
    EnsDb.Hsapiens.v79, 
    keys = ensembl_gene_ids,
    column = "SYMBOL", 
    keytype = "GENEID", 
    multiVals = "first"
) %>% 
    enframe(name = "ensembl_gene_id", value = "gene_symbol") %>% 
    mutate(gene_symbol = ifelse(is.na(gene_symbol), ensembl_gene_id, gene_symbol))
```

## DESeq2

```{r deseq2}
## Build a formula object (DESeq2 wants a formula, not a model matrix)
design_formula <- as.formula(paste0("~ ", paste0(colnames(m_covariates), collapse = " + ")))


## Construct DESeq2 dataset
dds <- DESeqDataSetFromMatrix(countData = m_counts,
                              colData = m_covariates,
                              design = design_formula
)

## Run DESeq
dds <- DESeq(dds)

## Extract results
df_deseq2_res <- results(dds, name = "dx_SCZ_vs_Control") %>%
    as.data.frame() %>%
    rownames_to_column("ensembl_gene_id") %>%
    as_tibble() %>%
    clean_names() %>%
    left_join(df_ensembl_to_symbol) %>%
    dplyr::select(ensembl_gene_id, gene_symbol, everything()) %>%
    arrange(-abs(log2fold_change)) %>%
    mutate(padj = p.adjust(pvalue, method = "fdr"))
```

## Limma-voom

```{r limma}
## Create DGEList
dge <- DGEList(counts = m_counts)
dge <- calcNormFactors(dge)

## Design matrix
design <- model.matrix(~ dx + ., data = m_covariates)

# ## Optional: filter genes again using edgeRâ€™s method
# keep <- filterByExpr(dge, design)
# dge <- dge[keep, , keep.lib.sizes = FALSE]
# dge <- calcNormFactors(dge)  # Recalc after filtering

## Voom transformation
v <- voom(dge, design, plot = TRUE)

## Linear modeling
fit <- lmFit(v, design)
fit <- eBayes(fit)

## Extract results for dx
df_limma_res <- topTable(fit, coef = "dxSCZ", number = Inf) %>%
    rownames_to_column("ensembl_gene_id") %>%
    as_tibble() %>%
    clean_names() %>%
    left_join(df_ensembl_to_symbol) %>%
    dplyr::select(ensembl_gene_id, gene_symbol, everything()) %>%
    arrange(-abs(log_fc))
```

## Combine and save all differential expression results

```{r combine_results}
## Load Nirmala's DEG results
df_akula_res <- read_xlsx(path = paste0(base_dir, "data/Akula2021_geneLevel_21kgenes_baseMeanGe5_cqn-Rin-Race-GC_DESeq2-pvalsCorrected_betaPriorT-lfcShrink_092518.xlsx"),
                          sheet = "SczVsCtrls") %>% 
    clean_names %>% 
    dplyr::select(ensembl_gene_id, hgnc_symbol, base_mean, 
                  log2fold_change, lfc_se, stat, pvalue, padj) %>% 
    dplyr::rename("gene_symbol" = "hgnc_symbol")
    

## Combine DESeq2, limma, and Nirmala results
df_de_res_all <- df_deseq2_res %>% 
    dplyr::select(ensembl_gene_id, gene_symbol, log2fold_change, stat) %>%
    pivot_longer(3:4, names_to = "metric", values_to = "DESeq2") %>%
    mutate(metric = ifelse(str_detect(metric, "log"), "l2fc", "t_stat")) %>% 
    left_join(
        df_limma_res %>% 
            dplyr::select(ensembl_gene_id, gene_symbol, log_fc, t) %>% 
            pivot_longer(3:4, names_to = "metric", values_to = "Limma") %>% 
            mutate(metric = ifelse(str_detect(metric, "log"), "l2fc", "t_stat"))
    ) %>% 
    left_join(
        df_akula_res %>%
            dplyr::select(ensembl_gene_id, gene_symbol, log2fold_change, stat) %>% 
            pivot_longer(3:4, names_to = "metric", values_to = "Akula") %>% 
            mutate(metric = ifelse(str_detect(metric, "log"), "l2fc", "t_stat"))
    )


# Save
save(
    df_deseq2_res, df_limma_res, df_akula_res, df_de_res_all, 
    file = paste0(objects_dir, "DE_results.Rdata")
)
```

## Export DGE results as table for supplement

```{r tableS4}
write_xlsx(
    list("TableS4" = df_limma_res %>% arrange(-abs(t))), 
    path = paste0(tables_dir, "TableS4.DEGs.xlsx")
)
```

## Compare across methods

These plots are not included in the manuscript

```{r compare_methods}
##
df_de_res_all %>% 
    ggplot(aes(x = Akula, y = DESeq2)) +
    geom_hline(yintercept = 0, color = "gray") +
    geom_vline(xintercept = 0, color = "gray") +
    geom_abline(lty = 2) +
    geom_point() +
    geom_smooth(method = "lm") +
    stat_cor() +
    facet_wrap(vars(metric), scales = "free")
    
##
df_de_res_all %>% 
    ggplot(aes(x = Limma, y = DESeq2)) +
    geom_hline(yintercept = 0, color = "gray") +
    geom_vline(xintercept = 0, color = "gray") +
    geom_abline(lty = 2) +
    geom_point() +
    geom_smooth(method = "lm") +
    stat_cor() +
    facet_wrap(vars(metric), scales = "free")

##
df_de_res_all %>% 
    ggplot(aes(x = Limma, y = Akula)) +
    geom_hline(yintercept = 0, color = "gray") +
    geom_vline(xintercept = 0, color = "gray") +
    geom_abline(lty = 2) +
    geom_point() +
    geom_smooth(method = "lm") +
    stat_cor() +
    facet_wrap(vars(metric), scales = "free")
```

## Stats

Run permutation testing to assess the significant of relationships between Akula et al 2021 DEGs and our limma DEGs.

```{r FigS16b.stats}
### PERMUTE L2FC CORRELATION ###
n_perm <- 10000
df_limma_akula_cor_perm <- tibble()
set.seed(0406)
for (i in 1:n_perm) {
    
    if (i %% 100 == 0) {print(paste0("Running permutation ", i))}
    
    # Permute LFC within module
    df_tmp <- df_de_res_all %>% 
        left_join(df_modules_filt) %>%
        filter(!is.na(Akula) & metric == "l2fc") %>% 
        group_by(module) %>%
        mutate(permuted_l2fc = sample(Limma, replace = FALSE))
    
    # Calculate correlation between permuted data and Nirmala's LFC
    test <- cor.test(df_tmp$permuted_l2fc, df_tmp$Akula)
    correlation <- test$estimate
    p_value <- test$p.value

    # Append to tibble
    df_limma_akula_cor_perm <- df_limma_akula_cor_perm %>% 
        bind_rows(
            tibble(
                perm = i,
                correlation = correlation,
                p_value = p_value
            )
        )
    
}

## Calculate permutation p-values
de_limma_akula_perm_p <- df_limma_akula_cor_perm %>% 
    mutate(obs_corr = cor.test(
        df_de_res_all %>% filter(!is.na(Akula) & metric == "l2fc") %>% pull(Limma), 
        df_de_res_all %>% filter(!is.na(Akula) & metric == "l2fc") %>% pull(Akula), 
        )$estimate
    ) %>%
    summarise(
        perm_p = (sum(abs(correlation) >= abs(obs_corr)) + 1) / (n_perm + 1)
    )
#Pperm=1*10^-4


### PERMUTE T-STAT CORRELATION ###
n_perm <- 10000
df_limma_akula_cor_perm <- tibble()
set.seed(0406)
for (i in 1:n_perm) {
    
    if (i %% 100 == 0) {print(paste0("Running permutation ", i))}
    
    # Permute LFC within module
    df_tmp <- df_de_res_all %>% 
        left_join(df_modules_filt) %>%
        filter(!is.na(Akula) & metric == "t_stat") %>% 
        group_by(module) %>%
        mutate(permuted_t = sample(Limma, replace = FALSE))
    
    # Calculate correlation between permuted data and Nirmala's LFC
    test <- cor.test(df_tmp$permuted_t, df_tmp$Akula)
    correlation <- test$estimate
    p_value <- test$p.value

    # Append to tibble
    df_limma_akula_cor_perm <- df_limma_akula_cor_perm %>% 
        bind_rows(
            tibble(
                perm = i,
                correlation = correlation,
                p_value = p_value
            )
        )
    
}

## Calculate permutation p-values
de_limma_akula_perm_p <- df_limma_akula_cor_perm %>% 
    mutate(obs_corr = cor.test(
        df_de_res_all %>% filter(!is.na(Akula) & metric == "t_stat") %>% pull(Limma), 
        df_de_res_all %>% filter(!is.na(Akula) & metric == "t_stat") %>% pull(Akula), 
        )$estimate
    ) %>%
    summarise(
        perm_p = (sum(abs(correlation) >= abs(obs_corr)) + 1) / (n_perm + 1)
    )
#Pperm=1*10^-4
```

## Plots

### Figure 4A \| Volcano plot of DEGs

```{r Fig4a.prep}
df_fig4a <- df_limma_res %>% 
    mutate(fill = ifelse(p_value > 0.05, NA_real_, log_fc)) %>% 
    mutate(significant = ifelse(adj_p_val < 0.05, "yes", "no")) %>% 
    mutate(score = log_fc*-log10(p_value)) %>% 
    arrange(-abs(score)) %>% 
    mutate(label = ifelse(abs(score) > 3.5 | -log10(p_value) > 4.5, gene_symbol, NA))
```

```{r Fig4a.plot, fig.width = 2.17, fig.height = 2.0}
df_fig4a %>% 
    ggplot(aes(x = log_fc, y = -log10(p_value))) +
    geom_point(aes(fill = fill, color = significant), 
               shape = 21, size = 1) +
    geom_hline(aes(yintercept = -log10(0.05)), 
               lty = 2, linewidth = 0.5, color = "black") +
    geom_text_repel(aes(label = label), 
                    min.segment.length = 0, 
                    size = 2,
                    max.overlaps = 10) +
    scale_fill_gradientn(colors = rev(brewer.rdbu(100)), 
                         #values = rescale(c(-0.17, 0, 0.17)),
                         limits = c(-2.3, 2.3),
                         na.value = "lightgray", guide = "none") +
    scale_color_manual(values = c("yes" = "black", "no" = "transparent"), 
                       na.value = "transparent") +
    guides(color = guide_legend(title = "FDR < 0.05", title.vjust = -1.5)) +
    labs(x = "log2(fold change)", y = "-log10(P)",
         title = "A | DEG volcano plot") +
    xlim(c(-2.3, 2.3)) +
    theme(#legend.position = c(0.01, 0.91),
        #legend.spacing.x = unit(0.1, "mm"),
        #legend.background = element_blank(),
        #legend.box.background = element_rect(colour = "black")
        legend.position = "none"
    )

# Save
map(
  .x = c(".png", ".pdf"),
  .f = ~ ggsave(paste0(figures_dir, "4A.DEG_volcano_plot", .x), 
                width = 2.17, height = 2.0)
)
```

### Figure 4B \| Top n genes by L2FC

```{r Fig4b.plot, fig.width = 2.17, fig.height = 2.0}
df_limma_res %>% 
    slice_max(order_by = abs(log_fc), n = 11) %>% 
    mutate(
        gene_symbol = ifelse(gene_symbol == "ENSG00000283443", "ZNF285DP", gene_symbol),
        gene_symbol = ifelse(gene_symbol == "ENSG00000283299", "ZNF285DP", gene_symbol)
    ) %>% # manually change ensembl gene IDs not correctly mapped
    
    ggplot(aes(x = log_fc, y = reorder(gene_symbol, log_fc))) +
    geom_point(aes(size = -log10(p_value), fill = log_fc), shape = 21) +
    geom_vline(xintercept = 0, color = "gray") +
    scale_fill_gradientn(colors = rev(brewer.rdbu(100)), 
                         limits = c(-2.5, 2.5), guide = "none") +
    scale_size_continuous(range = c(1, 4)) +
    guides(size = guide_legend(title = "-log10(P)")) +
    xlim(c(-2.5, 2.5)) +
    coord_cartesian(clip = "off") +
    labs(y = NULL, x = "log2(fold change)", 
         title ="B | Top 10 DEGs"
    ) +
    theme(
        legend.position = c(0.6, 0.3), 
        legend.box = "horizontal",
        legend.key.size = unit(0.35, "cm"),
        legend.key.height = unit(0.1, "cm"),
        legend.title = element_text(margin = margin(t = -5))
    )

# Save
map(
  .x = c(".png", ".pdf"),
  .f = ~ ggsave(paste0(figures_dir, "4B.top_10_DEGs", .x), width = 2.17, height = 2.0)
)
```

### Figure S16A \| Compare limma DEG results with Akula et al 2021 & GRCCA res

```{r FigS16a.prep}
## Venn diagram (overlap with Nirmala's results)
my_degs <- df_limma_res %>% dplyr::filter(p_value < 0.05) %>% pull(ensembl_gene_id)
length(my_degs) # N = 1389

akula_degs <- df_akula_res %>% 
    dplyr::filter(pvalue < 0.05) %>% 
    pull(ensembl_gene_id)
length(akula_degs) # N = 1373

sig_grcca_genes <- df_x_res %>% 
    dplyr::filter(p_adj < 0.05 & abs(z_score) > 2) %>% 
    pull(ensembl_gene_id)
length(sig_grcca_genes) # N = 1211

# Akula DEGs vs my DEGs
hypergeometric_overlap <- f_hypergeometric(my_degs, akula_degs, gene_universe = ensembl_gene_ids)
length(hypergeometric_overlap$overlap_genes) # N = 385; P = 1.9*10^-145; OR = 7.17

# GRCCA vs my DEGs
hypergeometric_overlap <- f_hypergeometric(my_degs, sig_grcca_genes, gene_universe = ensembl_gene_ids)
length(hypergeometric_overlap$overlap_genes) # N = 203; P = 1.5*10^-29; OR = 2.77

# GRCCA vs Akula DEGs
hypergeometric_overlap <- f_hypergeometric(akula_degs, sig_grcca_genes, gene_universe = ensembl_gene_ids)
length(hypergeometric_overlap$overlap_genes) # N = 285; P = 2.3*10^-85; OR = 5.19

# Combine the data into a named list for ggvenn
FigS16a_data <- list(
  `Current study DEGs` = my_degs,
  `Akula et al 2021 DEGs` = akula_degs,
  `Significant GRCCA genes` = sig_grcca_genes
)
```

```{r FigS16a.plot}
ggvenn(
    FigS16a_data, 
    fill_color = c("#E0E0E0", "#E0E0E0", "#E0E0E0"),
    stroke_size = 0.75,
    text_size = 3,
    set_name_size = 4,
    show_percentage = FALSE) +
    coord_fixed(clip = "off") +
    theme_void() +
    theme(
        text = element_text(size = 8)
    )
map(
  .x = c(".png", ".pdf"),
  .f = ~ ggsave(paste0(suppl_figures_dir, "S16A.DEG_GRCCA_venn_diagram", .x), 
                width = 2.5, height = 2)
)
```

### Figure S16B \| Correlation plot of L2FC

```{r FigS16b.plot, fig.width = 4, fig.height = 2.25}
df_de_res_all %>% 
    mutate(metric = ifelse(metric == "l2fc", "L2FC", "t-statistic")) %>% 
    
    ggplot(aes(x = Akula, y = Limma)) +
    geom_hline(yintercept = 0, color = "gray") +
    geom_vline(xintercept = 0, color = "gray") +
    geom_abline(lty = 2) +
    geom_point(color = "darkgray", size = 0.25) +
    geom_smooth(method = "lm", linewidth = 0.5, color = "maroon") +
    stat_cor(label.sep = "\n", size = 3, vjust = 1) +
    facet_wrap(vars(metric), scales = "free") +
    #scale_color_gradientn(colors = rev(brewer.rdbu(100)), guide = "none") +
    labs(
        x = "Akula DGE (DESeq2)", y = "Current study DGE (Limma-voom)",
        title = "B | Correlation between DGE analysis results"
    )

## Save
map(
  .x = c(".png", ".pdf"),
  .f = ~ ggsave(paste0(supp_figures_dir, "S16B.DEG_correlation", .x), 
                width = 4, height = 2.25)
)
```
